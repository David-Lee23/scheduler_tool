<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <title>Trip Schedule Viewer</title>
  <!-- Tailwind via CDN -->
  <script src='https://cdn.tailwindcss.com'></script>
  <!-- Supabase JS (ESM) will be imported in the module script below -->
  <style>
    /* Fallback fonts + small tweaks */
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body class='bg-gray-50 p-4'>
  <!-- SCHEDULE SECTION -->
  <section id='schedule'>
    <div class='flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4'>
      <h1 class='text-2xl font-bold'>Trip Schedules</h1>
    </div>
    <div class='flex flex-wrap gap-4 mb-4'>
      <input id='nassCodeFilter' placeholder='Filter by NASS code' class='border p-2 rounded flex-grow' />
      <input id='dateFilter' type='date' class='border p-2 rounded' />
    </div>
    <div class='grid grid-cols-1 md:grid-cols-2 gap-6'>
      <!-- Trips table -->
      <table class='w-full bg-white rounded shadow text-sm'>
        <thead class='bg-gray-200'>
          <tr>
            <th class='p-2 text-left'>NASS Code</th>
            <th class='p-2 text-left'>Facility</th>
            <th class='p-2 text-left'>Vehicle</th>
            <th class='p-2 text-left'>Arrive Time</th>
            <th class='p-2 text-left'>Depart Time</th>
          </tr>
        </thead>
        <tbody id='tripsBody'></tbody>
      </table>

      <!-- Trip Details -->
      <div class='bg-white rounded shadow p-4'>
        <h3 class='text-lg font-semibold mb-3'>Trip Details</h3>
        <div id='tripDetails' class='text-sm space-y-2'>
          <p class='italic text-gray-400'>Select a trip to view details...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN APP SCRIPT -->
  <script type='module'>
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ðŸ”‘ TODO: Replace with your project credentials
    const SUPABASE_URL = 'https://xisfjmzachsfyzlgbbyx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhpc2ZqbXphY2hzZnl6bGdiYnl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0NzcwMDIsImV4cCI6MjA2NTA1MzAwMn0.YRk_6vCc3PsZqyREGQJ1uENl1GSf0PABKxtBUNopLMo';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const tripsBody = document.getElementById('tripsBody');
    const tripDetails = document.getElementById('tripDetails');
    const nassCodeFilter = document.getElementById('nassCodeFilter');
    const dateFilter = document.getElementById('dateFilter');

    // --- DATA LOADERS ------------------------------------------------------
    async function loadTrips() {
      let query = supabase
        .from('trips')
        .select('*')
        .order('arrive_time', { ascending: true });

      if (nassCodeFilter.value.trim()) {
        query = query.ilike('nass_code', `%${nassCodeFilter.value.trim()}%`);
      }
      if (dateFilter.value) {
        // Filter by effective date range
        query = query.lte('eff_date', dateFilter.value).gte('exp_date', dateFilter.value);
      }

      const { data: trips, error } = await query;
      if (error) {
        console.error(error);
        tripsBody.innerHTML = `<tr><td class='p-2 text-red-600' colspan='5'>${error.message}</td></tr>`;
        return;
      }
      renderTrips(trips || []);
    }

    function renderTrips(trips) {
      tripsBody.innerHTML = '';
      if (trips.length === 0) {
        tripsBody.innerHTML = "<tr><td class='p-2 italic text-gray-400' colspan='5'>No trips found</td></tr>";
        return;
      }
      trips.forEach((t) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-100 cursor-pointer';
        tr.innerHTML = `
          <td class='p-2'>${t.nass_code || ''}</td>
          <td class='p-2'>${t.facility || ''}</td>
          <td class='p-2'>${t.vehicle || ''}</td>
          <td class='p-2'>${t.arrive_time || ''}</td>
          <td class='p-2'>${t.depart_time || ''}</td>`;
        tr.addEventListener('click', () => showTripDetails(t));
        tripsBody.appendChild(tr);
      });
    }

    function showTripDetails(trip) {
      tripDetails.innerHTML = `
        <div class='space-y-2'>
          <p><strong>Trip ID:</strong> ${trip.trip_id || 'N/A'}</p>
          <p><strong>Stop Number:</strong> ${trip.stop_number || 'N/A'}</p>
          <p><strong>NASS Code:</strong> ${trip.nass_code || 'N/A'}</p>
          <p><strong>Facility:</strong> ${trip.facility || 'N/A'}</p>
          <p><strong>Vehicle:</strong> ${trip.vehicle || 'N/A'}</p>
          <p><strong>Frequency:</strong> ${trip.freq || 'N/A'}</p>
          <p><strong>Frequency Days:</strong> ${trip.freq_days || 'N/A'}</p>
          <p><strong>Load/Unload:</strong> ${trip.load_unload || 'N/A'}</p>
          <p><strong>Arrive Time:</strong> ${trip.arrive_time || 'N/A'}</p>
          <p><strong>Depart Time:</strong> ${trip.depart_time || 'N/A'}</p>
          <p><strong>Effective Date:</strong> ${trip.eff_date || 'N/A'}</p>
          <p><strong>Expiration Date:</strong> ${trip.exp_date || 'N/A'}</p>
          ${trip.trip_miles ? `<p><strong>Trip Miles:</strong> ${trip.trip_miles}</p>` : ''}
          ${trip.trip_hrs ? `<p><strong>Trip Hours:</strong> ${trip.trip_hrs}</p>` : ''}
          ${trip.drive_time ? `<p><strong>Drive Time:</strong> ${trip.drive_time}</p>` : ''}
        </div>
      `;
    }

    // --- EVENT LISTENERS ---------------------------------------------------
    nassCodeFilter.addEventListener('input', loadTrips);
    dateFilter.addEventListener('input', loadTrips);

    // Initialize the app by loading trips
    loadTrips();
  </script>
</body>
</html>
