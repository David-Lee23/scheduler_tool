<!DOCTYPE html>
<html>
<head>
    <title>Trip Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Trucking Schedule MVP</a>
            <div>
                <a href="/" class="btn btn-outline-light me-2">Dashboard</a>
                <a href="/upload" class="btn btn-outline-light me-2">Upload PDF</a>
                <a href="/shifts" class="btn btn-outline-light">My Shifts</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Trip Management</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>Build Shift</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="shiftName" placeholder="Enter shift name">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success" id="createShiftBtn" disabled>Create Shift</button>
                    </div>
                </div>
                <div id="selectedTrips" class="mt-2"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Available Trips</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Trip ID</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Start Location</th>
                            <th>End Location</th>
                            <th>Stops</th>
                        </tr>
                    </thead>
                    <tbody id="tripsTable">
                        <tr><td colspan="7">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="result" class="mt-3" style="display: none;"></div>
    </div>

    <script>
        let selectedTripIds = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadTrips();
            document.getElementById('createShiftBtn').addEventListener('click', createShift);
        });

        async function loadTrips() {
            try {
                const response = await fetch('/api/trips');
                const data = await response.json();
                
                if (response.ok && data.trips) {
                    renderTrips(data.trips);
                } else {
                    document.getElementById('tripsTable').innerHTML = 
                        '<tr><td colspan="7">No trips found. Upload a PDF first.</td></tr>';
                }
            } catch (error) {
                document.getElementById('tripsTable').innerHTML = 
                    '<tr><td colspan="7">Error loading trips</td></tr>';
            }
        }

        function renderTrips(trips) {
            document.getElementById('tripsTable').innerHTML = trips.map(trip => `
                <tr>
                    <td><input type="checkbox" value="${trip.trip_id}" onchange="toggleTrip(${trip.trip_id})"></td>
                    <td>${trip.trip_id}</td>
                    <td>${trip.start_time || 'N/A'}</td>
                    <td>${trip.end_time || 'N/A'}</td>
                    <td>${trip.start_location || 'N/A'}</td>
                    <td>${trip.end_location || 'N/A'}</td>
                    <td>${trip.stop_count}</td>
                </tr>
            `).join('');
        }

        function toggleTrip(tripId) {
            if (selectedTripIds.includes(tripId)) {
                selectedTripIds = selectedTripIds.filter(id => id !== tripId);
            } else {
                selectedTripIds.push(tripId);
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('selectedTrips').innerHTML = 
                selectedTripIds.length > 0 ? `Selected: ${selectedTripIds.join(', ')}` : '';
            document.getElementById('createShiftBtn').disabled = selectedTripIds.length === 0;
        }

        async function createShift() {
            const shiftName = document.getElementById('shiftName').value || 
                             `Shift_${new Date().toISOString().slice(0,19)}`;
            
            try {
                const response = await fetch('/api/shifts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        shift_name: shiftName,
                        trip_ids: selectedTripIds
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('result').innerHTML = `
                        <div class="alert alert-success">
                            <h5>âœ… Shift Created Successfully!</h5>
                            <p><strong>Name:</strong> ${data.shift.shift_name}</p>
                            <p><strong>Trips:</strong> ${data.shift.trip_count}</p>
                            <p><strong>Time:</strong> ${data.shift.start_time} - ${data.shift.end_time}</p>
                            <div class="mt-3">
                                <a href="/shifts" class="btn btn-primary">View All Shifts</a>
                                <button class="btn btn-secondary" onclick="clearResult()">Create Another</button>
                            </div>
                        </div>
                    `;
                    
                    // Clear selections and form
                    selectedTripIds = [];
                    document.getElementById('shiftName').value = '';
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    updateUI();
                    
                } else {
                    document.getElementById('result').innerHTML = `
                        <div class="alert alert-danger">${data.error}</div>
                    `;
                }
                
                document.getElementById('result').style.display = 'block';
                
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <div class="alert alert-danger">Error: ${error.message}</div>
                `;
                document.getElementById('result').style.display = 'block';
            }
        }

        function clearResult() {
            document.getElementById('result').style.display = 'none';
        }
    </script>
</body>
</html> 